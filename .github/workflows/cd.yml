name: Home Machine Test - CD Pipeline
on:
  workflow_run:
    workflows: ["Home Machine Test - CI Pipeline"]
    branches: ["development"]
    types:
      - completed

jobs:

  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Free up memory (t2.micro optimization)
      run: |
        echo "ğŸ†“ Optimizing for AWS Free Tier t2.micro..."
        sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches || true
        docker system prune -f || true
    
    - name: Pull Docker Image
      run: sudo docker pull wolf4war/foodie:latest
    
    - name: Delete existing container
      run: sudo docker rm -f foodie || true
    
    - name: Run the Docker image (t2.micro optimized)
      run: sudo docker run -d -p 443:80 --name foodie --memory="800m" --restart=unless-stopped wolf4war/foodie:latest
    
    - name: Test internet connectivity from container
      run: |
        echo "ğŸŒ Testing internet connectivity from container..."
        sudo docker exec foodie curl -f -s --max-time 10 https://api.themealdb.com/json/v1/1/categories.json > /dev/null && echo "âœ… Container has internet access" || echo "âŒ No internet access"
    
    - name: Wait for application to be ready
      run: |
        echo "Waiting for application to start..."
        timeout=60
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f -s http://localhost:443 > /dev/null 2>&1; then
            echo "âœ… Application is ready!"
            break
          fi
          sleep 3
          counter=$((counter + 3))
          echo "â³ Waiting... ($counter/$timeout seconds)"
        done
    
    - name: Clean up old images
      run: |
        docker image prune -f
    
    - name: Display deployment info
      run: |
        echo "âœ… Free Tier Deployment successful!"
        echo "ğŸ”— Application URL: http://$(curl -s --max-time 5 http://checkip.amazonaws.com/ || echo 'N/A'):443"
        echo "ğŸ†“ Running on AWS Free Tier t2.micro"