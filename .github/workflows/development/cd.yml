name: Development - CD Deploy
on:
  workflow_run:
    workflows: ["Development - CI Build"]
    types: [completed]
    branches: [development]
  # Manual trigger for debugging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: ğŸ  Deployment Started
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ  STARTING HOME LAB DEPLOYMENT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“ Server: $(hostname)"
        echo "ğŸŒ IP: $(curl -s --max-time 5 http://checkip.amazonaws.com/ || echo 'Unknown')"
        echo "â° Time: $(date)"
        echo "ğŸ”„ Event: ${{ github.event_name }}"
        
    - name: ğŸ” System Check
      run: |
        echo "ğŸ–¥ï¸ System Information:"
        echo "  CPU: $(nproc) cores"
        echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
        echo "  Disk: $(df -h / | tail -1 | awk '{print $4}') available"
        echo "  Docker: $(docker --version)"
        echo ""
        
    - name: ğŸ†“ Memory Optimization
      run: |
        echo "ğŸ§¹ Optimizing memory for t2.micro..."
        sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches || true
        docker system prune -f || true
        echo "âœ… Memory optimization complete"
        
    - name: ğŸ“¥ Pull Docker Image
      run: |
        echo "ğŸ“¥ Pulling latest Docker image..."
        sudo docker pull wolf4war/foodie:latest
        echo "âœ… Image pulled successfully"
        
    - name: ğŸ›‘ Stop Existing Container
      run: |
        echo "ğŸ›‘ Stopping existing container..."
        if sudo docker ps -q -f name=foodie; then
          sudo docker stop foodie
          sudo docker rm foodie
          echo "âœ… Existing container removed"
        else
          echo "â„¹ï¸ No existing container to remove"
        fi
        
    - name: ğŸš€ Start New Container
      run: |
        echo "ğŸš€ Starting new Foodie container..."
        sudo docker run -d \
          -p 443:80 \
          --name foodie \
          --memory="800m" \
          --restart=unless-stopped \
          wolf4war/foodie:latest
        echo "âœ… Container started successfully"
        
    - name: â±ï¸ Wait for Container
      run: |
        echo "â±ï¸ Waiting for container to initialize..."
        sleep 10
        echo "âœ… Wait complete"
        
    - name: ğŸŒ Test Internet Connectivity
      run: |
        echo "ğŸŒ Testing container internet access..."
        if sudo docker exec foodie curl -f -s --max-time 10 https://api.themealdb.com/json/v1/1/categories.json > /dev/null; then
          echo "âœ… Container has internet access"
        else
          echo "âŒ Internet connectivity test failed"
          echo "ğŸ“‹ Container logs:"
          sudo docker logs foodie --tail 10
        fi
        
    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Performing application health check..."
        timeout=60
        counter=0
        
        while [ $counter -lt $timeout ]; do
          if curl -f -s http://localhost:443 > /dev/null 2>&1; then
            echo "âœ… Application is responding!"
            break
          fi
          sleep 3
          counter=$((counter + 3))
          echo "â³ Waiting... ($counter/$timeout seconds)"
        done
        
        if [ $counter -ge $timeout ]; then
          echo "âŒ Application health check failed"
          echo "ğŸ“‹ Container status:"
          sudo docker ps -f name=foodie
          echo "ğŸ“‹ Container logs:"
          sudo docker logs foodie --tail 20
          exit 1
        fi
        
    - name: ğŸ§¹ Cleanup
      run: |
        echo "ğŸ§¹ Cleaning up old images..."
        docker image prune -f || true
        echo "âœ… Cleanup complete"
        
    - name: ğŸ‰ Deployment Success
      run: |
        PUBLIC_IP=$(curl -s --max-time 5 http://checkip.amazonaws.com/ || echo 'Unknown')
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ  Server: foodie-development"
        echo "ğŸ”— URL: http://$PUBLIC_IP:443"
        echo "ğŸ³ Container: foodie (running)"
        echo "ğŸ’¾ Memory: 800MB limit"
        echo "ğŸ†“ AWS Free Tier t2.micro"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"