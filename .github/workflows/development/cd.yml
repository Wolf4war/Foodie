name: Development - CD Deploy

on:
  workflow_run:
    workflows: ["Development - CI Build"]
    types: [completed]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    if: ${{ github.event_name == 'workflow_dispatch' || 
            (github.event.workflow_run.conclusion == 'success' && 
             github.event.workflow_run.head_branch == 'development') }}

    steps:
    - name: ğŸ  Deployment Started
      run: |
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ  STARTING HOME LAB DEPLOYMENT"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“ Server: $(hostname)"
        echo "ğŸŒ IP: $(curl -s --max-time 5 http://checkip.amazonaws.com/ || echo 'Unknown')"
        echo "â° Time: $(date)"
        echo "ğŸ”„ Event: ${{ github.event_name }}"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ” System Check
      run: |
        echo "ğŸ–¥ï¸ System Information:"
        echo "  CPU: $(nproc) cores"
        echo "  Memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
        echo "  Disk: $(df -h / | tail -1 | awk '{print $4}') available"
        echo "  Docker: $(docker --version)"
        echo ""

    - name: ğŸ†“ Memory Optimization
      run: |
        echo "ğŸ§¹ Optimizing memory for t2.micro..."
        sudo sync && echo 3 | sudo tee /proc/sys/vm/drop_caches || true
        docker system prune -f || true
        echo "âœ… Memory optimization complete"

    - name: ğŸ“¥ Pull Docker Image
      run: |
        echo "ğŸ“¥ Pulling latest Docker image..."
        docker pull wolf4war/foodie:latest
        echo "âœ… Image pulled successfully"

    - name: ğŸ›‘ Stop Existing Container
      run: |
        echo "ğŸ›‘ Stopping existing container (if any)..."
        if [ "$(docker ps -q -f name=foodie)" ]; then
          docker stop foodie
          docker rm foodie
          echo "âœ… Existing container removed"
        else
          echo "â„¹ï¸ No existing container to remove"
        fi

    - name: ğŸš€ Start New Container
      run: |
        echo "ğŸš€ Starting new Foodie container..."
        docker run -d \
          -p 80:80 \
          --name foodie \
          --memory="800m" \
          --restart=unless-stopped \
          wolf4war/foodie:latest
        echo "âœ… Container started successfully"

    - name: â±ï¸ Wait for Container
      run: |
        echo "â±ï¸ Waiting 15 seconds before health check..."
        sleep 15
        echo "âœ… Wait complete"

    - name: ğŸŒ Test Internet Connectivity
      run: |
        echo "ğŸŒ Testing container internet access..."
        if docker exec foodie curl -f -s --max-time 10 https://api.themealdb.com/json/v1/1/categories.php > /dev/null; then
          echo "âœ… Container has internet access"
        else
          echo "âŒ Internet connectivity test failed"
          echo "ğŸ“‹ Container logs:"
          docker logs foodie --tail 10
        fi

    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Performing application health check..."
        timeout=120
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f -s http://localhost:80 > /dev/null 2>&1; then
            echo "âœ… Application is responding!"
            break
          fi
          sleep 3
          counter=$((counter + 3))
          echo "â³ Waiting... ($counter/$timeout seconds)"
        done

        if [ $counter -ge $timeout ]; then
          echo "âŒ Application health check failed"
          echo "ğŸ“‹ Container status:"
          docker ps -f name=foodie
          echo "ğŸ“‹ Container logs:"
          docker logs foodie --tail 20
          exit 1
        fi

    - name: ğŸ§¹ Cleanup
      run: |
        echo "ğŸ§¹ Cleaning up old images..."
        docker image prune -f
        echo "âœ… Cleanup complete"

    - name: ğŸ‰ Deployment Success
      run: |
        PUBLIC_IP=$(curl -s --max-time 5 http://checkip.amazonaws.com/ || echo 'Unknown')
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ‰ DEPLOYMENT COMPLETED SUCCESSFULLY!"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ  Server: foodie-development"
        echo "ğŸ”— URL: http://$PUBLIC_IP:80"
        echo "ğŸ³ Container: foodie (running)"
        echo "ğŸ’¾ Memory: 800MB limit"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
